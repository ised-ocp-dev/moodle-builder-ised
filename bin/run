#!/bin/bash
# This script is run when the pod is starting up.

source ${PHP_CONTAINER_SCRIPTS_PATH}/common.sh

export_vars=$(cgroup-limits); export $export_vars
export DOCUMENTROOT=${DOCUMENTROOT:-/}

# Default php.ini configuration values, all taken
# from php defaults.
export ERROR_REPORTING=${ERROR_REPORTING:-E_ALL & ~E_NOTICE}
export DISPLAY_ERRORS=${DISPLAY_ERRORS:-STDERR}
export DISPLAY_STARTUP_ERRORS=${DISPLAY_STARTUP_ERRORS:-OFF}
export TRACK_ERRORS=${TRACK_ERRORS:-OFF}
export HTML_ERRORS=${HTML_ERRORS:-ON}
export INCLUDE_PATH=${INCLUDE_PATH:-.:/opt/app-root/src:${PHP_DEFAULT_INCLUDE_PATH}}
export PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT:-128M}
export SESSION_NAME=${SESSION_NAME:-PHPSESSID}
export SESSION_HANDLER=${SESSION_HANDLER:-files}
export SESSION_PATH=${SESSION_PATH:-/tmp/sessions}
export SESSION_COOKIE_DOMAIN=${SESSION_COOKIE_DOMAIN:-}
export SESSION_COOKIE_HTTPONLY=${SESSION_COOKIE_HTTPONLY:-}
export SESSION_COOKIE_SECURE=${SESSION_COOKIE_SECURE:-0}
export SHORT_OPEN_TAG=${SHORT_OPEN_TAG:-OFF}
export UPLOAD_MAX_FILESIZE=${UPLOAD_MAX_FILESIZE:-500M}

# TODO should be dynamically calculated based on container memory limit/16
export OPCACHE_MEMORY_CONSUMPTION=${OPCACHE_MEMORY_CONSUMPTION:-128}
export OPCACHE_REVALIDATE_FREQ=${OPCACHE_REVALIDATE_FREQ:-60}

export PHPRC=${PHPRC:-${PHP_SYSCONF_PATH}/php.ini}
export PHP_INI_SCAN_DIR=${PHP_INI_SCAN_DIR:-${PHP_SYSCONF_PATH}/php.d}

# Update php.ini with configurable post_max_size and upload_max_filesize.
sed -i "s,^post_max_size =.*$,post_max_size = $UPLOAD_MAX_FILESIZE," /opt/app-root/etc/php.ini.template
sed -i "s,^upload_max_filesize =.*$,upload_max_filesize = $UPLOAD_MAX_FILESIZE," /opt/app-root/etc/php.ini.template

envsubst < /opt/app-root/etc/php.ini.template > ${PHP_SYSCONF_PATH}/php.ini
envsubst < /opt/app-root/etc/php.d/10-opcache.ini.template > ${PHP_SYSCONF_PATH}/php.d/10-opcache.ini

# export OPCACHE_MAX_ACCELERATED_FILES=${OPCACHE_MAX_ACCELERATED_FILES:-10000}
sed -i 's,^opcache.max_accelerated_files=.*$,opcache.max_accelerated_files=10000,' ${PHP_SYSCONF_PATH}/php.d/10-opcache.ini

export HTTPD_START_SERVERS=${MOODLE_START_SERVERS:-8}
export HTTPD_MIN_SPARE_SERVERS=${MOODLE_MIN_SPARE_SERVERS:-8}
export HTTPD_MAX_SPARE_SERVERS=${MOODLE_MAX_SPARE_SERVERS:-18}
export HTTPD_MAX_REQUEST_WORKERS=${MOODLE_MAX_REQUEST_WORKERS:-256}
export HTTPD_MAX_KEEP_ALIVE_REQUESTS=${MOODLE_MAX_KEEP_ALIVE_REQUESTS:-100}

echo "-> HTTPD_START_SERVERS=${HTTPD_START_SERVERS}"
echo "-> HTTPD_MIN_SPARE_SERVERS=${HTTPD_MIN_SPARE_SERVERS}"
echo "-> HTTPD_MAX_SPARE_SERVERS=${HTTPD_MAX_SPARE_SERVERS}"
echo "-> HTTPD_MAX_REQUEST_WORKERS=${HTTPD_MAX_REQUEST_WORKERS}"
echo "-> HTTPD_MAX_KEEP_ALIVE_REQUESTS=${HTTPD_MAX_KEEP_ALIVE_REQUESTS}"


# if [ -n "${NO_MEMORY_LIMIT:-}" -o -z "${MEMORY_LIMIT_IN_BYTES:-}" ]; then
#   #
#   export HTTPD_MAX_REQUEST_WORKERS=${HTTPD_MAX_REQUEST_WORKERS:-256}
# else
#   # A simple calculation for MaxRequestWorkers would be: Total Memory / Size Per Apache process.
#   # The total memory is determined from the Cgroups and the average size for the
#   # Apache process is estimated to 15MB.
#   max_clients_computed=$((MEMORY_LIMIT_IN_BYTES/1024/1024/15))
#   # The MaxClients should never be lower than StartServers, which is set to 5.
#   # In case the container has memory limit set to <64M we pin the MaxClients to 4.
#   [[ $max_clients_computed -le 4 ]] && max_clients_computed=4
#   export HTTPD_MAX_REQUEST_WORKERS=${HTTPD_MAX_REQUEST_WORKERS:-$max_clients_computed}
#   echo "-> Cgroups memory limit is set, using HTTPD_MAX_REQUEST_WORKERS=${HTTPD_MAX_REQUEST_WORKERS}"
# fi

# pre-start files
process_extending_files ${APP_DATA}/php-pre-start/ ${PHP_CONTAINER_SCRIPTS_PATH}/pre-start/

exec httpd -D FOREGROUND
